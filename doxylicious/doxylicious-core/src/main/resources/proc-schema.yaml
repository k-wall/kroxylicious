$schema: https://json-schema.org/draft/2020-12/schema
$id: https://kroxylicious.io/schema/proc-schema.yaml
title: Proc
description: A procedure which can be documented and executed
$defs:
  ProcId:
    description: The id of a procedure
    type: string
    pattern: [0-9a-zA-Z-_]+
  Adoc:
    description: An object containing documentation
    type: object
    additionalProperties: false
    properties:
      adoc:
        description: Documentation in AsciiDoc format
        type: string
  Steps:
    type: array
    items:
      $ref: "#/$defs/Step"
  Step:
    description: A step to be performed, which might be pure documentation, or a command to execute.
    oneOf:
      - $ref: "#/$defs/ProcId"
      - $ref: "#/$defs/Exec"
      - type: object
        additionalProperties: false
        properties:
          properties:
            step:
              $ref: "#/$defs/Steps"
  Exec:
    description: A command to execute as a subprocess
    oneOf:
      - description: A command to execute with default options
        type: string
      - description: A command to execute when a higher amount of control is needed
        type: object
        additionalProperties: false
        properties:
          dir:
            description: The working directory of the subprocess
            type: string
          env:
            description: The environment for the subprocess
            type: object
            additionalProperties: true
          command:
            description: A command to execute (split on blanks)
            type: string
          args:
            description: A command to execute as an array of process arguments
            type: array
            items:
              type: string
          exitCodes:
            description: The allowed return codes (anything else is treated an an error)
            type: array
            items:
              type: integer
          timeout:
            description: A timeout for subprocess completion
            $ref: "#/$defs/Timeout"
          destroyTimeout:
            description: |
              When the subprocess does not return within the timeout and it killed, this is the additional timeout 
              before it will be destroyed forcibly (aka SIGKILL).
            $ref: "#/$defs/Timeout"
          standardOutput:
            $ref: "#/$defs/OutputFileAssertions"
          standardError:
            $ref: "#/$defs/OutputFileAssertions"
  Timeout:
    description: A timeout, as a quantity and a unit of time
    type: string
    pattern: "[0-9]+[h|m|s|ms]"
  OutputFileAssertions:
    description: Assertions on the content of some command output
    additionalProperties: false
    type: object
    properties:
      contains:
        type: string
      containsAll:
        type: string
      containsAny:
        type: string
      doesNotContain:
        type: string
type: object
additionalProperties: false
required:
  - id
properties:
  id:
    description: The id of this procedure
    $ref: "#/$defs/ProcId"
  title2:
    $ref: "#/$defs/Adoc"
  notional:
    type: boolean
  satisfies:
    $ref: "#/$defs/ProcId"
  abstract:
    $ref: "#/$defs/Adoc"
  intro:
    $ref: "#/$defs/Adoc"
  prereqs:
    type: array
    items:
      required:
        - "ref"
      allOf:
        - $ref: "#/$defs/Adoc"
        - type: object
          properties:
            ref:
              $ref: "#/$defs/ProcId"
  procedure:
    $ref: "#/$defs/Steps"
  verification:
    $ref: "#/$defs/Steps"
  additionalResources:
    $ref: "#/$defs/ProcId"
